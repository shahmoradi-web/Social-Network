<div class="post" data-post-id="{{ post.id }}">
    <div>
        {% for img in post.images.all %}
            <img src="{{ img.imag_file.url }}" alt="{{ img.title }}">
        {% endfor %}
    </div>
    {{ post.description| linebreaks }}
    Published at {{ post.created|date:'Y-m-d'}} by {{ post.author }}
    <br>
    <button class="like-button">
        {% if request.user in post.likes.all%}
            Unlike
        {% else %}
            Like
        {% endif %}
    </button>
    <span class="likes-count">{{ post.likes.count }}</span> likes
</div>

<button class="save-button">
        {% if request.user in post.saved_by.all%}
            Unsaved
        {% else %}
            saved
        {% endif %}
</button>
<br>
{% for tag in post.tags.all %}
    tags:
    <a href="{% url 'social:post_list_by_tag' tag.slug %}">{{ tag.name }}</a>
    {% if not forloop.last %},{% endif %}
{% endfor %}

<h2>Similar Post</h2>
{% for post in similar_post %}
    <p>
        <a href="{{ post.get_absolute_url }}">{{ post.description| truncatewords:10 }}</a>
    </p>
{% empty %}
    there are no similar post
{% endfor %}

<div id="comment-list">
    <h2> Comments </h2>
    {% if post.comments.all %}
        {% for comment in post.comments.all %}
            <p>At {{ comment.created }} {{comment.user}} commented:</p>
            <p>{{comment.body}}</p>
        {% endfor %}
    {% endif %}
</div>

<div id="comment-div">
    <form action="{% url 'social:post_comment' %}" id="comment-form">
        <input type="hidden" id="post-id" value="{{post.id}}">
        <textarea id="comment-body" maxlength="255" rows="4" cols="50"></textarea>
        <br>
        <button type="submit" id="submit-comment">Comment</button>
    </form>
    <hr>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>

    $(document).ready(function (){
        $('.like-button').click(function (){
            var post_id = $(this).closest('.post').data('post-id');
            var button = $(this);

            $.ajax({
                type:'POST',
                url:'{% url 'social:like_post' %}',
                data:{'post_id':post_id, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                success: function (data){
                    if (data.liked){
                        button.text('Unlike');
                    } else{
                        button.text('Like');
                    }
                    $('.likes-count').text(data.likes_count);

                },
            });

        });

    });
    $('.save-button').click(function (){
            var button = $(this);

            $.ajax({
                type:'POST',
                url:'{% url 'social:save_post' %}',
                data:{'post_id':{{ post.id }}, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                success: function (data){
                    if (data.saved){
                        button.text('Unsaved');
                    } else{
                        button.text('saved');
                    }

                },
                error: function (error){
                    console.log("خطا در ارسال درخواستAJAX" + error);
                }
            });

        });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $('#submit-comment').click( function (e) {
        e.preventDefault();
        var url = $('#comment-form').attr("action");
        var post_id = $('#post-id').attr("value");
        var body = $('#comment-body').val();
        const csrftoken = getCookie('csrftoken');

        $.ajax({
            method: "POST",
            url: url,
            headers: {'X-CsrfToken': csrftoken},
            data: JSON.stringify({ post_id: post_id, body: body }),
            success: function(comment) {
                $('#comment-div').prop("hidden", true);
                $('#comment-body').val('');
                $('#comment-list').append(
                    `<p>At ${comment.created} ${comment.user} commented:</p>
                    <p>${comment.body}</p>`
                );
            }
        });
    });


</script>

<div>
    {% with comments.count as cm_count %}
        {{ cm_count }} comment{{ cm_count | pluralize }}
    {% endwith %}
</div>
<div>
    {% for cm in comments %}

        {{ cm.body }}
        {{ cm.name }}
        <hr>
    {% empty %}
            کامنتی وجود ندار
    {% endfor %}
</div>

<form method="post" action="{% url 'social:post_comment' post.id%}">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="submit" value="افزودن کامنت">
</form>